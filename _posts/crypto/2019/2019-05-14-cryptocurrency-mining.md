---
layout:        post
title:         "なぜマイニングをするとお金が支払われるのか"
date:          2019-05-14
category:      Crypto
author:        tex2e
cover:         /assets/cover4.jpg
redirect_from:
comments:      true
published:     true
---

なぜビットコインなどのブロックチェーンでマイニングをするとお金が支払われるのか、について簡単に説明します。
ちなみに私はブロックチェーンへの攻撃方法について考える側の人なので、仮想通貨やりたいとか、マイニングしたいとかそういう人ではないので悪しからず。

一応、文中で使う言葉の確認です：

- ネットワーク ... ブロックチェーンの分散台帳技術におけるネットワークのこと
- ノード ... ネットワークに参加しているパソコンのこと。ブロックの検証・生成・追加などを行う
- ブロック ... トランザクション（取引）をまとめたもの
- ナンス ... nonce (Number used once の略) は、一度だけ使用される使い捨ての数字のこと

### ブロックの構造

まず、ビットコインのブロックの構造は次のようになっています[^bluebacks_blockchain]。

- ブロック
  - マジックナンバ ... 識別用番号
  - ブロックサイズ ... ブロックの大きさ
  - ブロックヘッダ
    - バージョンナンバー
    - 前のブロックのハッシュ値
    - マークルルート ... このブロックの全てのトランザクションからハッシュ木を作ったときのルートハッシュ
    - ブロックを作った時刻
    - **ブロックを作る難易度** ... このブロックのハッシュ値の先頭の 0 の数
    - **ナンス** ... このブロックのハッシュ値の先頭が 000...0 となるもの
  - トランザクションカウンタ ... トランザクション（取引）の数
  - トランザクション ... トランザクション（取引）の一覧

ブロックを作るには、このブロックのハッシュ値の先頭が 000...0 となる「ナンス」を見つける必要があり、最初に条件を満たすナンスを見つけたノードにブロックを追加する権利が与えられます。そして、ブロックを追加したノードにはマイニング報酬が支払われます。

余談ですが、改竄防止のおいて重要なのは「前のブロックのハッシュ値」を求めることです。全てのブロックが前のブロックのハッシュ値を持っていることで、改竄を防ぐことができるようになります。


### ブロックが作られるまでの流れ

ブロックが作られるまでの大まかな流れは以下の通りです。

1. トランザクション（取引）発生
2. トランザクションはトランザクションプールに貯められる
3. 10分ごとにマイナーがトランザクションプールからトランザクションを集める
4. 前のブロックのハッシュ値とルートハッシュを計算する
5. このブロックのハッシュ値の先頭が 000...0 となるナンスを見つける（この作業が一番時間がかかる）
6. 条件を満たすナンスを最初に見つけたマイナーがブロックを追加できる（**Proof-of-Work**）
7. マイナーに報酬が仮想通貨で支払われる（自分の作ったブロックの一番最初のトランザクションで支払われる）

次はブロック作成について例を使いながら説明していきます。


### ブロックの作成とマイニング

ブロックチェーンは分散台帳技術なので、複数のノードでブロックが作られるとチェーンが分岐してしまいます（フォーク）。フォークした場合はチェーンが長い方を正当なブロックとするというルールがありますが、頻繁にチェーンが発生しないようにするために、ブロックを作る難易度をあげる対策が取られています。

一方で、ブロックを作る難易度が高すぎてブロックが数時間後に追加されるようになると、トランザクションが確定するまでに時間がかかってしまい、送金などの利便性が悪くなります。

そこでビットコインでは10分に1つのブロックが作られるようにし、ブロックを作る難易度も今日のコンピュータ資源の計算速度などに合わせて、難易度が調整されています。

ブロックの作成にはブロックを作る難易度に合った条件を満たす、ナンスの見つける必要があります。
ブロックのハッシュ値の先頭に $n$ 個の 0 が並ぶようなナンスが必要ですが、
この $n$ の値がブロックを作る難易度になります。

適当な例で計算してみましょう。例えば、計算を簡単にするためにブロックの構造が「blockheader + nonce + transaction」というものだとします。blockheader と transaction にはそれぞれ「hogehoge」と「fugafuga」という内容が書かれているとします（適当ですが）。
では、ブロックを作る難易度として $n = 4$ としてみましょう。つまり、求めたハッシュ値の先頭の 4 文字が 0 になるようなナンス（nonce）を見つけることが目標になります。
これを見つける Python は次のようになります。

```python
import re
import hashlib

blockheader = b"hogehoge"
transaction = b"fugafuga"

for i in range(100000):
    # ナンスは数字をバイト列に変換したもの
    nonce = i.to_bytes(4, byteorder='big')
    # ブロックの作成
    block = blockheader + nonce + transaction
    # ブロックのハッシュ値をSHA-256で求める
    res = hashlib.sha256(block).hexdigest()
    # ハッシュ値の先頭4文字が0になっているか
    if re.match(r'^0000.*', res):
        print(i, block, res)
        break
```

実行すると次のようになります。
左から「ナンス」「ブロックの中身」「ハッシュ値」です。

```command
32505 b'hogehoge\x00\x00~\xf9fugafuga' 0000863b42e71c357a3a21365b3749efa2adb1473922f22372b77e8f196ec88d
```

ハッシュ値（0000863b42e71c357a3a2...）の先頭が 0000 となるようなナンス（32505）を見つけることができました。
$n=4$ だとすぐに計算が終わりますが、実際には難易度が $n=18,19$ とかになっていて、簡単にはナンスを求めることができないようになっています。

余談ですが、ビットコインで使用されるハッシュ関数は SHA-256 と RIPEMD-160 です。
これらのハッシュは GPU で計算するのに向いているためです [^GPU]。
今回のプログラムでは SHA-256 をハッシュ関数として使いました。

マイニングはこのように、ナンスをどんどん変更させてハッシュ値を計算していきますが、大量の電気を消費して永遠と計算してはゴミのような結果を出し続けるところを、一獲千金を狙う採掘者（マイナー）が永遠と土を掘り続けてゴミのような結果を出し続けるのになぞらえて、マイナーやマイニングという単語が生まれたと言われています。
もちろん、条件を満たすナンスを見つけることができれば報酬が得られ、大金を手にすることができますが...


### マイニング報酬がもたらす安全性

ブロックチェーンのネットワークはインターネットを通して繋がっているので、世界中の人がブロックの追加によってマイニング報酬を得ることができ、より一層マイニング競争に拍車がかかっています。実は、このことはブロックチェーンの安全性をも高めています。

ビットコインに対する攻撃として**51%攻撃**というものがあります。偽のトランザクションを加えたブロックを作り、そのブロックをチェーンに加えることでフォークを発生させ、ネットワーク全体のマイニング速度よりも早くナンスを求め、次々とチェーンを伸ばすことで正当なブロックにしてしまう攻撃です（ネットワーク全体の51%以上の計算能力を支配しているところが名前の由来）。

ですが、この攻撃をするためには非常に膨大な計算力と、そのための大量の資金が必要です。
また、偽のトランザクションを含むブロックが混入されたことが知られれば、その仮想通貨の価値は下がり、せっかく不正をして得たお金の価値が下がってしまうことになりかねません。
なので、膨大な計算力を持っているのなら、それをマイニングに使ってマイニング報酬で儲ける方が、ローリスクハイリターンとなるので、不正をする動機がなくなり、結果としてブロックチェーンの安全性を保つことができているのです[^block_reward] [^block_reward2]。


### まとめ

- マイニングとは、ブロックを作成すること
- ブロックが簡単に作れるとフォークが頻発するので、ブロック作成には適切な難易度が設定されている
- 「ブロックチェーンが正しく機能するため」と「51%攻撃をする動機を減らすため」にマイニング報酬が支払われている


-----

[^bluebacks_blockchain]: 岡嶋裕史『[ブロックチェーン　相互不信が実現する新しいセキュリティ](https://www.amazon.co.jp/%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%83%81%E3%82%A7%E3%83%BC%E3%83%B3-%E7%9B%B8%E4%BA%92%E4%B8%8D%E4%BF%A1%E3%81%8C%E5%AE%9F%E7%8F%BE%E3%81%99%E3%82%8B%E6%96%B0%E3%81%97%E3%81%84%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3-%E3%83%96%E3%83%AB%E3%83%BC%E3%83%90%E3%83%83%E3%82%AF%E3%82%B9-%E5%B2%A1%E5%B6%8B-%E8%A3%95%E5%8F%B2/dp/4065144353)』, 講談社, 2019
[^GPU]: SHA-256はGPUで計算するのに向いているので、機械学習といいマイニングといい、GPUを作っている会社はとても好調のようです
[^block_reward]: マイニング報酬はブロックの一番最初のトランザクションで支払われるので、いくらなのか確認することができる。2019/05/14 に作成されたブロックを見ると[^chainflyer]、約 13 BTC（執筆時のレートで日本円で**約1100万**）のマイニング報酬が支払われたことになる。
[^block_reward2]: ただし、マイニング報酬には半減期が設定されており、ブロックが伸びるほど報酬は少なくなっていく。最近では「マイニング報酬が限りなく0に近づいたとき、ブロックチェーンは正しく機能しているのか＆それでも安全性は保たれるのか」という議論が専ら盛んに行われている
[^chainflyer]: ブロックチェーンを可視化するサイト：[chainFlyer \| Blockchain Explorer](http://chainflyer.bitflyer.jp/)
